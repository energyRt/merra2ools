---
title: "Solar Power"
output: rmarkdown::html_vignette
header-includes:
   - \usepackage{amsmath}
vignette: >
  %\VignetteIndexEntry{Solar Power}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, eval = FALSE}
library(merra2ools)
library(tidyverse)
library("cowplot")


```

# Plane of Array (POA) irradiance model
## All steps at once
```{r, eval = FALSE}
# Example dataset
merra <- merra2_sample(c(3), add.coord = T)
merra
x <- fPOA(merra)

```


<details><summary>Figure code</summary>
```{r, eval = FALSE}
fig.POA <- function(x, name, 
                    legend.position = NULL, 
                    timestamp.position = NULL, ...) {
  plot_merra(x, name = name, limits = c(0, 1200), 
           # legend.position = c(0.88, 0.05), 
           legend.position = legend.position,
           legend.name = ("W/\u33A1"), 
           timestamp.position = timestamp.position,
           expand.x = c(0.002, 0.005), expand.y = c(0.002, 0.005)
           )
}
fig.POA(x, "SWGDN")

fig.poa.grid <- function(x, 
                         legend.position = c(0.81, 0.08), 
                         timestamp.position = c(125, 85), 
                         ...) {
  plot_grid(fig.POA(x, "SWGDN", ...), 
            fig.POA(x, "POA.fh", timestamp.position = timestamp.position, ...),
            fig.POA(x, "POA.fl", ...), 
            fig.POA(x, "POA.th", ...),
            fig.POA(x, "POA.tv", ...), 
            fig.POA(x, "POA.td", legend.position = legend.position, ...),
            # fig.dPS(x),
            labels = c("GHI", "POA.fh", "POA.fl", "POA.th", "POA.tv", "POA.td"),
            ncol = 2, nrow = 3, hjust = -0.1, vjust = 1.1, label_size = 12,
            label_colour = "black")
}
fig.poa.grid(x)

# ii <- lubridate::hour(x$UTC) <= 2; summary(ii)
gif_merra(x, FUN = "fig.poa.grid", dirname = "images", fps = 10,
          gif.width = 1.25 * 576, 
          gif.height = 1.25 * 360 * 1.21, 
          filename.prefix = "POA_map_")


```
</details>

```{r fig_POA_all, fig.cap="Plane of Array (POA) Irradiance estimates for alternative tracking systems", echo=FALSE}
gif_file <- "../images/POA_map_720x544_5fps.gif"
if (file.exists(gif_file)) include_graphics(gif_file)

```



## Step-by-step
### Solar postion

```{r, eval = FALSE}
# x <- fPOA(merra, keep.all = T)
x <- solar_position(merra, keep.all = T)
ii <- x$hour == 12; summary(ii)
x <- x[ii,]

```

<details><summary>Figure code</summary>

```{r, eval = FALSE}

x$na <- 1L; x$na[!x$beam] <- NA # drop nights

summary(x$beam)
plot_merra(x, "beam", limits = c(0, 1), palette = "YlGnBu",
           legend.name = "")

summary(x$declination)
fig.declination <- function(x, limits = c(-.5, .5), 
                            legend.name = "angle\u00b0", 
                            ...) {
  plot_merra(x, "declination", limits = limits, 
             # palette = "YlGnBu",
             legend.name = legend.name, ...)
}
fig.declination(x)

summary(x$eq_time)
fig.eq_time <- function(x, limits = c(-15, 15), ...) {
  plot_merra(x, "eq_time", limits = limits, palette = "PRGn", 
                            legend.name = "Munutes", direction = -1, ...)
}
fig.eq_time(x)

summary(x$solar_time)
fig.solar_time <- function(x, limits = c(-12, 36), 
           palette = "Dark2", legend.name = "Hours", 
           ...) {
  plot_merra(x, "solar_time", limits = limits, 
             palette = palette, legend.name = legend.name, ...)
}
fig.solar_time(x)
  
summary(x$hour_angle)
summary(rad2deg(x$hour_angle))
fig.hour_angle <- function(x, limits = c(-360, 360), scale = 180/pi, 
           palette = "Set1", legend.name = "angle\u00b0", 
           direction = 1, ...) {
  plot_merra(x, "hour_angle", limits = limits, scale = scale,
             palette = palette, legend.name = legend.name, direction = direction, ...)
}
fig.hour_angle(x)

summary(x$zenith)
fig.zenith <- function(x, ...) {
  plot_merra(x, "zenith", limits = c(0, 90), 
             direction = 1, 
             scale = x$na,
             palette = "Spectral", 
             legend.name = "angle\u00b0", ...)
}
fig.zenith(x)

summary(x$azimuth)
fig.azimuth <- function(x, ...) {
  plot_merra(x, "azimuth", limits = c(0, 360), 
             legend.name = "angle\u00b0",
             palette = "Set1",
             # palette = "Blues", 
             scale = x$na, direction = -1, ...)
}
fig.azimuth(x)

fig.solar_postion <- function(x, 
                         legend.position = c(0.81, 0.08), 
                         timestamp.position = c(125, 85), 
                         ...) {
  plot_grid(fig.declination(x, timestamp.position = NULL, 
                            legend.position = legend.position, ...), 
            fig.eq_time(x, timestamp.position = timestamp.position, 
                        legend.position = legend.position, ...),
            fig.solar_time(x, timestamp.position = NULL, 
                           legend.position = legend.position, ...), 
            fig.hour_angle(x, timestamp.position = NULL, 
                           legend.position = legend.position, ...),
            fig.zenith(x, timestamp.position = NULL, 
                       legend.position = legend.position, ...), 
            fig.azimuth(x, legend.position = legend.position, 
                        timestamp.position = NULL, ...),
            # fig.dPS(x),
            labels = c("declination", "eq_time", "solar_time", 
                       "hour_angle", "zenith", "azimuth"),
            ncol = 2, nrow = 3, hjust = -0.1, vjust = 1.1, label_size = 12,
            label_colour = "black")
}
fig.solar_postion(x)

# ii <- lubridate::hour(x$UTC) <= 2; summary(ii)
gif_merra(x, FUN = "fig.solar_postion", dirname = "images", fps = 5,
          gif.width = 1.25 * 576, 
          gif.height = 1.25 * 360 * 1.21, 
          filename.prefix = "fig.solar_postion_")

```
<details>


```{r fig_sol_pos, fig.cap="Solar position variables", echo=FALSE}
gif_file <- "../images/fig.solar_postion_720x544_10fps.gif"
if (file.exists(gif_file)) include_graphics(gif_file)

```


### Global Horizontal Irradiance decomposition

<details><summary>Figure code</summary>
```{r, eval = FALSE}
x <- solar_irradiance(x, keep.all = T)

summary(x$ext_irrad)
fig.ext_irrad <- function(x, ...) {
plot_merra(x, "ext_irrad", limits = c(1300, 1450), direction = 1,
           palette = "Oranges", legend.name = "W/\u33A1", ...)
}
fig.ext_irrad(x)

summary(x$clearness_index)
fig.clearness_index <- function(x, ...) {
  plot_merra(x, "clearness_index", limits = c(0, 1), direction = -1, palette = "Blues")
}
fig.clearness_index(x)

summary(x$diffuse_fraction)
fig.diffuse_fraction <- function(x) {
  plot_merra(x, "diffuse_fraction", limits = c(0, 1), palette = "Blues", direction = 1)
}
fig.diffuse_fraction(x)

summary(x$DNI)
# merra[x$DNI > x$ext_irrad,]
# x[x$DNI > x$ext_irrad,]
# solar_irradiance(x[x$DNI > x$ext_irrad,])

fig.DNI <- function(x) {
  plot_merra(x, "DNI", limits = c(0, 1500))
}
fig.DNI(x)

summary(x$DHI)
plot_merra(x, "DHI", limits = c(0, 1500))

```
<details>



### PV-array position

<details><summary>Figure code</summary>
```{r, eval = FALSE}
x <- pv_array_position(x, array.type = "all")
x

fig.array.tilt <- function(x, array.type = "fl", ...) {
  plot_merra(x, paste0("array.tilt.", array.type), limits = c(0, 90), 
             palette = "Set1", direction = -1, ...)
}

fig.array.azimuth <- function(x, array.type = "fl", ...) {
  plot_merra(x,  paste0("array.azimuth.", array.type), limits = c(0, 360), 
             direction = -1, palette = "Set1", ...)
}

summary(x$array.tilt.fh); summary(x$array.azimuth.fh)
fig.array.tilt(x, "fh")
fig.array.azimuth(x, "fh")

summary(x$array.tilt.fl); summary(x$array.azimuth.fl)
fig.array.tilt(x, "fl")
fig.array.azimuth(x, "fl")

summary(x$array.tilt.th); summary(x$array.azimuth.th)
fig.array.tilt(x, "th")
fig.array.azimuth(x, "th", scale = x$na)

# summary(x$array.tilt.tl); summary(x$array.azimuth.tl)
# fig.array.tilt(x, "tl")
# fig.array.azimuth(x, "tl", scale = x$na)

summary(x$array.tilt.tv); summary(x$array.azimuth.tv)
fig.array.tilt(x, "tv")
fig.array.azimuth(x, "tv", scale = x$na)

summary(x$array.tilt.td); summary(x$array.azimuth.td)
fig.array.tilt(x, "tv")
fig.array.azimuth(x, "tv", scale = x$na)

fig.position.grid <- function(
  x, legend.position = c(0.81, 0.08), 
  timestamp.position = c(125, 85), ...) {
  plot_grid(
    fig.array.tilt(x, "fh", timestamp.position = NULL, legend.position = NULL, ...), 
    fig.array.azimuth(x, "fh", timestamp.position = timestamp.position, 
                      legend.position = NULL, ...),
    fig.array.tilt(x, "fl", timestamp.position = NULL, legend.position = NULL, ...), 
    fig.array.azimuth(x, "fl", timestamp.position = NULL, legend.position = NULL, ...),
    fig.array.tilt(x, "th", scale = x$na, 
                   timestamp.position = NULL, legend.position = NULL, ...), 
    fig.array.azimuth(x, "th",  scale = x$na, 
                   timestamp.position = NULL, legend.position = NULL, ...),
    fig.array.tilt(x, "tv", scale = x$na, 
                   timestamp.position = NULL, legend.position = NULL, ...), 
    fig.array.azimuth(x, "tv", scale = x$na, 
                   timestamp.position = NULL, legend.position = NULL, ...),
    fig.array.tilt(x, "td", scale = x$na, 
                   timestamp.position = NULL, legend.position = NULL, ...), 
    fig.array.azimuth(x, "td", scale = x$na, 
                   timestamp.position = NULL, legend.position = legend.position, ...),
  labels = c("fh - tilt", "fh - azimuth", 
             "fl - tilt", "fl - azimuth", 
             "th - tilt", "th - azimuth", 
             # "tl - tilt", "tl - azimuth", 
             "tv - tilt", "tv - azimuth", 
             "td - tilt", "td - azimuth"),
            ncol = 2, hjust = -0.1, vjust = 1.1, label_size = 12,
            label_colour = "black")
}
fig.position.grid(x)

ggsave("images/solar_array_position_by_type_tl.png", width = 7, height = 10.5)

```
<details><summary>Figure code</summary>


### Angle of Incidence (AOI)
```{r, eval = FALSE}
x <- angle_of_incidence(x, array.type = "all")

fig.AOI <- function(x, array.type = "fl", ...) {
  plot_merra(x, paste0("AOI.", array.type), limits = c(0, 90), direction = 1, 
             palette = "Blues", scale = 180/pi)
}
summary(x$AOI.fh); summary(rad2deg(x$AOI.fh))
fig.AOI(x, "fh")

summary(rad2deg(x$AOI.fl))
fig.AOI(x, "fl")

summary(rad2deg(x$AOI.th))
fig.AOI(x, "th")

summary(rad2deg(x$AOI.tv))
fig.AOI(x, "tv")

summary(rad2deg(x$AOI.td))
fig.AOI(x, "td")



```

### Plane of Array (POA) irradiance 
```{r, eval = FALSE}
x <- poa_irradiance(x, array.type = "all", keep.all = T)
fig.poa.grid(x)



```

### Plane of Array (POA) irradiance 
```{r, eval = FALSE}
x <- poa_irradiance(x, verbose = 0, array.type = "tl", keep.all = T)

summary(x$POA.td)
# summary(rad2deg(x$POAb.td))
plot_merra(x, "POA.td", limits = c(0, 1200), direction = -1, 
           # palette = "Blues", 
           # na.value = "#000336",
           # na.value = "#000F4D",
           # na.value = "#002366",
           # na.value = "#040434",
           # na.value = "#070B34",
           scale = x$na)

# save(x, )

```



